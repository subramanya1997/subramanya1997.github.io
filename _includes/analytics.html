{% if site.google_analytics and jekyll.environment == 'production' %}
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  // Basic configuration with enhanced measurement
  gtag('config', '{{ site.google_analytics }}', {
    'send_page_view': true,
    'anonymize_ip': true,
    'allow_google_signals': true,
    'allow_ad_personalization_signals': false
    {% if page.layout == 'post' %}{% assign word_count = page.content | number_of_words %}{% assign reading_time_mins = word_count | divided_by: 200 %}{% if reading_time_mins == 0 %}{% assign reading_time_mins = 1 %}{% endif %},
    'custom_map': {
      'dimension1': 'post_category',
      'dimension2': 'post_tags',
      'dimension3': 'reading_time',
      'dimension4': 'post_date',
      'dimension5': 'word_count'
    },
    'post_category': '{{ page.categories | first | default: "uncategorized" }}',
    'post_tags': '{{ page.tags | join: ", " | escape }}',
    'reading_time': {{ reading_time_mins }},
    'post_date': '{{ page.date | date: "%Y-%m-%d" }}',
    'word_count': {{ word_count }}
    {% endif %}
  });

  {% if page.title %}
  // Track page view with custom parameters
  gtag('event', 'page_view', {
    'page_title': '{{ page.title | escape }}',
    'page_location': window.location.href,
    'page_path': '{{ page.url }}',
    {% if page.layout == 'post' %}
    'content_type': 'blog_post',
    'content_category': '{{ page.categories | first | default: "uncategorized" }}',
    {% elsif page.layout == 'page' %}
    'content_type': 'page',
    {% endif %}
  });
  {% endif %}
</script>

{% if site.google_optimize %}
<!-- Google Optimize -->
<script src="https://www.googleoptimize.com/optimize.js?id={{ site.google_optimize }}"></script>
{% endif %}

<!--
  Enhanced Analytics Tracking (external file)
  Uses Intersection Observer instead of scroll events for better performance
  - Scroll depth tracking with Intersection Observer
  - Reading progress with Intersection Observer
  - Event delegation for link tracking
  - All tracking is non-blocking
-->
<script src="{{ '/assets/js/analytics-enhanced.js' | prepend: site.baseurl }}" defer></script>

<!-- Track 404 errors immediately (no defer needed) -->
{% if page.url contains '404' %}
<script>
  if (typeof gtag === 'function') {
    gtag('event', 'exception', {
      'description': '404 Error - Page not found: ' + window.location.pathname,
      'fatal': false
    });
  }
</script>
{% endif %}
{% endif %}

