<!-- Language Switcher Component -->
<div class="language-switcher" id="languageSwitcher" role="navigation" aria-label="Language selection">
  <button class="language-switcher-toggle" 
          id="languageSwitcherToggle" 
          type="button"
          aria-haspopup="listbox" 
          aria-expanded="false"
          aria-label="Select language">
    <span class="current-lang" id="currentLangLabel">English</span>
    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>
  
  <ul class="language-dropdown" id="languageDropdown" role="listbox" aria-label="Available languages">
    {% comment %}
    Only show languages where translations exist for this post.
    English is always shown as it's the source language.
    {% endcomment %}
    {% for lang in site.languages %}
      {% comment %}Get post slug from page URL{% endcomment %}
      {% assign url_parts = page.url | split: '/' %}
      {% assign post_slug = url_parts | last | remove: '.html' %}
      
      {% comment %}Check if translation file exists for this language{% endcomment %}
      {% assign translation_path = '/assets/translations/' | append: lang.code | append: '/' | append: post_slug | append: '.json' %}
      {% assign translation_exists = false %}
      {% for static_file in site.static_files %}
        {% if static_file.path == translation_path %}
          {% assign translation_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      
      {% comment %}Always show English (default) or if translation exists{% endcomment %}
      {% if lang.code == site.default_lang or translation_exists %}
    <li class="language-option{% if lang.code == site.default_lang %} active{% endif %}" 
        role="option"
        data-lang="{{ lang.code }}"
        aria-selected="{% if lang.code == site.default_lang %}true{% else %}false{% endif %}"
        tabindex="0">
      <span class="lang-native">{{ lang.native }}</span>
      <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </li>
      {% endif %}
    {% endfor %}
  </ul>
</div>

<style>
/* Language Switcher Styles */
.language-switcher {
  position: relative;
  display: inline-flex;
  align-items: center;
  z-index: 100;
}

.language-switcher-toggle {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background-color: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.language-switcher-toggle:hover {
  background-color: var(--bg-secondary);
  color: var(--text-primary);
}

.language-switcher.open .language-switcher-toggle,
.language-switcher-toggle:focus {
  border-color: var(--accent);
  outline: none;
}

.language-switcher-toggle .dropdown-arrow {
  flex-shrink: 0;
  transition: transform 0.2s ease;
}

.language-switcher.open .dropdown-arrow {
  transform: rotate(180deg);
}

.language-dropdown {
  position: absolute;
  top: calc(100% + 6px);
  right: 0;
  min-width: 200px;
  max-height: 320px;
  overflow-y: auto;
  background-color: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
  list-style: none;
  margin: 0;
  padding: 6px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px) scale(0.98);
  transform-origin: top right;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] .language-dropdown {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
}

.language-switcher.open .language-dropdown {
  opacity: 1;
  visibility: visible;
  transform: translateY(0) scale(1);
}

.language-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border-radius: 8px;
  color: var(--text-secondary);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.language-option:hover,
.language-option:focus {
  background-color: var(--bg-tertiary);
  color: var(--text-primary);
  outline: none;
}

.language-option.active {
  color: var(--text-primary);
  font-weight: 500;
}

.language-option.active .check-icon {
  opacity: 1;
}

.language-option .lang-native {
  flex: 1;
}

.language-option .check-icon {
  flex-shrink: 0;
  opacity: 0;
  color: var(--accent);
  transition: opacity 0.15s ease;
}

/* Scrollbar for dropdown */
.language-dropdown::-webkit-scrollbar {
  width: 6px;
}

.language-dropdown::-webkit-scrollbar-track {
  background: transparent;
}

.language-dropdown::-webkit-scrollbar-thumb {
  background-color: var(--border-color);
  border-radius: 3px;
}

.language-dropdown::-webkit-scrollbar-thumb:hover {
  background-color: var(--text-tertiary);
}

/* Mobile responsive */
@media screen and (max-width: 600px) {
  .language-switcher-toggle {
    padding: 8px 10px;
  }
  
  .language-dropdown {
    min-width: 180px;
    right: auto;
    left: 50%;
    transform: translateX(-50%) translateY(-10px) scale(0.98);
    transform-origin: top center;
  }
  
  .language-switcher.open .language-dropdown {
    transform: translateX(-50%) translateY(0) scale(1);
  }
}
</style>

<script>
(function() {
  'use strict';
  
  const switcher = document.getElementById('languageSwitcher');
  const toggle = document.getElementById('languageSwitcherToggle');
  const dropdown = document.getElementById('languageDropdown');
  const currentLangLabel = document.getElementById('currentLangLabel');
  const options = dropdown?.querySelectorAll('.language-option');
  
  if (!switcher || !toggle || !dropdown || !options) return;
  
  // Build language data from rendered options (only available languages)
  const languages = {};
  options.forEach(option => {
    const langCode = option.dataset.lang;
    const nativeName = option.querySelector('.lang-native')?.textContent;
    if (langCode && nativeName) {
      languages[langCode] = { native: nativeName };
    }
  });
  
  // Get current language
  function getCurrentLanguage() {
    // Priority: URL param > localStorage > browser > default
    const urlParams = new URLSearchParams(window.location.search);
    const urlLang = urlParams.get('lang');
    if (urlLang && languages[urlLang]) return urlLang;
    
    const storedLang = localStorage.getItem('preferredLanguage');
    if (storedLang && languages[storedLang]) return storedLang;
    
    return '{{ site.default_lang }}';
  }
  
  // Update visual state
  function updateCurrentLanguage(langCode) {
    const lang = languages[langCode];
    if (!lang) return;
    
    currentLangLabel.textContent = lang.native;
    
    options.forEach(option => {
      const optionLang = option.dataset.lang;
      const isActive = optionLang === langCode;
      option.classList.toggle('active', isActive);
      option.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
  }
  
  // Toggle dropdown
  function toggleDropdown(open) {
    const isOpen = open !== undefined ? open : !switcher.classList.contains('open');
    switcher.classList.toggle('open', isOpen);
    toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    
    if (isOpen) {
      // Focus first option when opened
      const activeOption = dropdown.querySelector('.language-option.active') || options[0];
      activeOption?.focus();
    }
  }
  
  // Handle language selection
  // This function only handles UI updates and dispatches the event.
  // The actual language switching logic is handled by i18n.js
  function selectLanguage(langCode) {
    if (!languages[langCode]) return;
    
    // Close dropdown and refocus toggle
    toggleDropdown(false);
    toggle.focus();
    
    // Dispatch i18n:languageChange event for i18n.js to handle
    // i18n.js is the single source of truth for:
    // - localStorage persistence
    // - URL management
    // - Translation loading
    // - State management
    document.dispatchEvent(new CustomEvent('i18n:languageChange', { 
      detail: { lang: langCode } 
    }));
  }
  
  // Event: Toggle click
  toggle.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDropdown();
  });
  
  // Event: Option click
  options.forEach(option => {
    option.addEventListener('click', () => {
      selectLanguage(option.dataset.lang);
    });
    
    option.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectLanguage(option.dataset.lang);
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = option.nextElementSibling;
        if (next) next.focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = option.previousElementSibling;
        if (prev) prev.focus();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        toggleDropdown(false);
        toggle.focus();
      }
    });
  });
  
  // Event: Click outside to close
  document.addEventListener('click', (e) => {
    if (!switcher.contains(e.target)) {
      toggleDropdown(false);
    }
  });
  
  // Event: Keyboard navigation on toggle
  toggle.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
      e.preventDefault();
      toggleDropdown(true);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      toggleDropdown(false);
    }
  });
  
  // Initialize on load
  document.addEventListener('DOMContentLoaded', () => {
    const currentLang = getCurrentLanguage();
    updateCurrentLanguage(currentLang);
  });
  
  // Listen for language changes from i18n.js to update UI state
  document.addEventListener('i18n:languageChanged', (e) => {
    if (e.detail && e.detail.lang) {
      updateCurrentLanguage(e.detail.lang);
    }
  });
})();
</script>
